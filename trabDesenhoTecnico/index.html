<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Visualizador de Imagem</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');

        body {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            margin: 50px;
            background: #089c90;
        }

        h2 {
            color: #1d1c1c;
            font-style: italic;
        }

        label {
            font-family: 'roboto';
        }

        .container {
            margin-top: 20px;
            background: #d3d3d3;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        img {
            max-width: 100%;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 10px;
        }

        .result {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .result-item {
            background: #d3d3d3;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .dim {
            font-size: 14px;
            margin-bottom: 10px;
        }

        button {
            transition: 0.2s;
        }
        
        button:hover {
            opacity: 0.85;
        }

    </style>
</head>
<body>

    <div id="titleSite">
        <h2 style="margin-left: 20px;">Trabalho de Desenho Técnico 2º termo - Engenharia da Computação</h2>
        <ul style="list-style: none;">
            <li>Arthur Romero Rossi</li>
            <li>Gabriel Henrique Meneghelli da Silva</li>
            <li>Maria Fernanda Pires de Oliveira</li>
        </ul>
    </div>

    <!-- Seção 1 -->
    <h2>1º - Carregar e Visualizar Imagem</h2>

    <div class="container">
        <label>Selecione uma imagem:</label><br>
        <input type="file" id="imageInput" accept="image/png, image/jpeg, image/bmp">

        <p id="dimensions"></p>
        <img id="preview" src="" alt="">
    </div>

    <!-- Seção 2 -->
    <h2>2º - Redução da Imagem (75%, 50%, 25%)</h2>

    <div class="container">
        <p>As reduções aparecerão automaticamente após selecionar a imagem.</p>
        <div class="result" id="result"></div>
    </div>

    <!-- Seção 3 -->
    <h2>3º - Conversão de Formato para WEBP</h2>

    <div class="container">
        <p><strong>Tamanho original:</strong> <span id="originalSize">---</span></p>
        <p><strong>Tamanho WEBP:</strong> <span id="webpSize">---</span></p>

        <img id="webpPreview" src="" alt="">

        <button id="downloadWebp" style="
            margin-top: 15px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: #0e6b62;
            color: white;
            cursor: pointer;
            font-weight: bold;
        " disabled>Baixar WEBP</button>
    </div>

    <!-- Seção 4 -->
    <h2>4º - Operação Geométrica — Espelhamento Vertical</h2>

    <div class="container">
        <p>A imagem espelhada aparecerá abaixo automaticamente.</p>

        <img id="flipPreview" src="" alt="">

        <button id="downloadFlip" style="
            margin-top: 15px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: #0e6b62;
            color: white;
            cursor: pointer;
            font-weight: bold;
        " disabled>Baixar Espelhamento</button>
    </div>

    <!-- Seção 5 -->
    <h2>5º - Operação de Cores — Tons de Cinza</h2>

    <div class="container">
        <p>A imagem em tons de cinza aparecerá abaixo automaticamente.</p>

        <img id="grayPreview" src="" alt="">

        <button id="downloadGray" style="
            margin-top: 15px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: #0e6b62;
            color: white;
            cursor: pointer;
            font-weight: bold;
        " disabled>Baixar Tons de Cinza</button>
    </div>

    <!-- Seção 6 -->
    <h2>6º - Histograma RGB + Estatísticas</h2>

    <div class="container">
        <p>Histogramas dos canais R, G e B e estatísticas calculadas automaticamente.</p>

        <div style="display:flex; flex-wrap:wrap; gap:20px;">
            <div>
                <h3>Histograma R</h3>
                <canvas id="histR" width="300" height="150" style="background:white;"></canvas>
                <p id="statsR"></p>
            </div>

            <div>
                <h3>Histograma G</h3>
                <canvas id="histG" width="300" height="150" style="background:white;"></canvas>
                <p id="statsG"></p>
            </div>

            <div>
                <h3>Histograma B</h3>
                <canvas id="histB" width="300" height="150" style="background:white;"></canvas>
                <p id="statsB"></p>
            </div>
        </div>
    </div>

    <!-- Seção 7 -->
    <h2>7º - Análise de Bits e Estrutura da Imagem</h2>

    <div class="container">
        <p>Informações sobre profundidade de cor, canais, dimensões e tamanho em memória.</p>

        <p id="bitsInfo"></p>
    </div>

    <!-- Seção 8 -->
    <h2>8º - Relatório Técnico</h2>

    <div class="container">
        <p>Gerar relatório técnico contendo todas as análises realizadas automaticamente.</p>

        <button id="btnRelatorio" style="
            margin-top: 15px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: #0e6b62;
            color: white;
            cursor: pointer;
            font-weight: bold;
        ">Gerar Relatório</button>

        <button id="btnBaixarRelatorio" disabled style="
            margin-top: 15px;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: #0e6b62;
            color: white;
            cursor: pointer;
            font-weight: bold;
        ">Baixar PDF</button>

        <div id="relatorio" style="
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            display:none;
        "></div>
    </div>

    <script>
        const input = document.getElementById("imageInput");
        const preview = document.getElementById("preview");
        const dimensions = document.getElementById("dimensions");
        const resultContainer = document.getElementById("result");

        const originalSizeTxt = document.getElementById("originalSize");
        const webpSizeTxt = document.getElementById("webpSize");
        const webpPreview = document.getElementById("webpPreview");
        const btnDownloadWebp = document.getElementById("downloadWebp");

        const flipPreview = document.getElementById("flipPreview");
        const btnDownloadFlip = document.getElementById("downloadFlip");

        let originalFileSize = 0;

        input.addEventListener("change", function () {
            const file = this.files[0];
            if (!file) return;

            originalFileSize = file.size;
            originalSizeTxt.textContent = formatBytes(originalFileSize);

            const reader = new FileReader();

            reader.onload = function (e) {
                preview.src = e.target.result;

                preview.onload = function () {
                    const width = preview.naturalWidth;
                    const height = preview.naturalHeight;

                    dimensions.textContent = `Dimensões: ${width} x ${height} pixels`;

                    gerarReducoes(preview, width, height);
                    converterParaWebp(preview, width, height);
                    gerarEspelhamento(preview, width, height);
                    gerarTonsDeCinza(preview, width, height);
                    gerarHistograma(preview, width, height);
                    analisarImagem(preview, width, height);


                };
            };

            reader.readAsDataURL(file);
        });

        /* ----------- 2. Reduções ----------- */
        function gerarReducoes(img, width, height) {
            resultContainer.innerHTML = "";

            const fatores = [
                { nome: "75%", fator: 0.75 },
                { nome: "50%", fator: 0.50 },
                { nome: "25%", fator: 0.25 }
            ];

            fatores.forEach(item => {
                const novoW = width * item.fator;
                const novoH = height * item.fator;

                const canvas = document.createElement("canvas");
                canvas.width = novoW;
                canvas.height = novoH;

                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, novoW, novoH);

                const newImg = document.createElement("img");
                newImg.src = canvas.toDataURL("image/png");

                const div = document.createElement("div");
                div.className = "result-item";

                const p = document.createElement("p");
                p.className = "dim";
                p.textContent = `Redução ${item.nome}: ${Math.round(novoW)} x ${Math.round(novoH)} pixels`;

                div.appendChild(p);
                div.appendChild(newImg);

                resultContainer.appendChild(div);
            });
        }

        /* ----------- 3. Converter para WEBP ----------- */
        function converterParaWebp(img, w, h) {
            const canvas = document.createElement("canvas");
            canvas.width = w;
            canvas.height = h;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);

            const webpData = canvas.toDataURL("image/webp", 0.8);

            webpPreview.src = webpData;

            const webpSize = Math.round((webpData.length * 3) / 4);
            webpSizeTxt.textContent = formatBytes(webpSize);

            btnDownloadWebp.disabled = false;
            btnDownloadWebp.onclick = function () {
                const a = document.createElement("a");
                a.href = webpData;
                a.download = "imagem_convertida.webp";
                a.click();
            };
        }

        /* ----------- 4. Espelhamento Vertical ----------- */
        function gerarEspelhamento(img, w, h) {
            const canvas = document.createElement("canvas");
            canvas.width = w;
            canvas.height = h;

            const ctx = canvas.getContext("2d");

            ctx.translate(w, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(img, 0, 0, w, h);

            const flippedData = canvas.toDataURL("image/png");

            flipPreview.src = flippedData;

            btnDownloadFlip.disabled = false;
            btnDownloadFlip.onclick = function () {
                const a = document.createElement("a");
                a.href = flippedData;
                a.download = "imagem_espelhada.png";
                a.click();
            };
        }

        /* ----------- formatar tamanho ----------- */
        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + " B";
            else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
            else return (bytes / (1024 * 1024)).toFixed(1) + " MB";
        }

        /* ----------- 5. Tons de Cinza ----------- */
        function gerarTonsDeCinza(img, w, h) {
            const canvas = document.createElement("canvas");
            canvas.width = w;
            canvas.height = h;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);

            let imgData = ctx.getImageData(0, 0, w, h);
            let data = imgData.data;

            // Converter pixel por pixel
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                // fórmula luminance
                const gray = 0.299 * r + 0.587 * g + 0.114 * b;

                data[i] = data[i + 1] = data[i + 2] = gray;
            }

            ctx.putImageData(imgData, 0, 0);

            const grayData = canvas.toDataURL("image/png");

            const grayPreview = document.getElementById("grayPreview");
            const btnGray = document.getElementById("downloadGray");

            grayPreview.src = grayData;
            btnGray.disabled = false;

            btnGray.onclick = function () {
                const a = document.createElement("a");
                a.href = grayData;
                a.download = "imagem_tons_de_cinza.png";
                a.click();
            };
        }

        /* ----------- 6. HISTOGRAMA RGB + ESTATÍSTICAS ----------- */
        function gerarHistograma(img, w, h) {

            const canvas = document.createElement("canvas");
            canvas.width = w;
            canvas.height = h;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);

            let imgData = ctx.getImageData(0, 0, w, h);
            let data = imgData.data;

            // Histograma com 256 posições
            let histR = new Array(256).fill(0);
            let histG = new Array(256).fill(0);
            let histB = new Array(256).fill(0);

            let valoresR = [], valoresG = [], valoresB = [];

            // Preenchendo histogramas
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];

                histR[r]++; histG[g]++; histB[b]++;
                valoresR.push(r); valoresG.push(g); valoresB.push(b);
            }

            // Funções estatísticas
            function calcularStats(valores) {
                valores.sort((a, b) => a - b);
                let min = valores[0];
                let max = valores[valores.length - 1];

                let media = valores.reduce((a, b) => a + b, 0) / valores.length;

                let mediana = valores.length % 2 === 0 ?
                    (valores[valores.length / 2 - 1] + valores[valores.length / 2]) / 2 :
                    valores[Math.floor(valores.length / 2)];

                let variancia = valores.reduce((acc, val) => acc + Math.pow(val - media, 2), 0) / valores.length;
                let desvio = Math.sqrt(variancia);

                return { min, max, media, mediana, desvio };
            }

            const statsR = calcularStats(valoresR);
            const statsG = calcularStats(valoresG);
            const statsB = calcularStats(valoresB);

            // Escrever estatísticas na tela
            document.getElementById("statsR").innerHTML =
                `Min: ${statsR.min} | Max: ${statsR.max} | Média: ${statsR.media.toFixed(2)}
                <br>Mediana: ${statsR.mediana} | Desvio-padrão: ${statsR.desvio.toFixed(2)}`;

            document.getElementById("statsG").innerHTML =
                `Min: ${statsG.min} | Max: ${statsG.max} | Média: ${statsG.media.toFixed(2)}
                <br>Mediana: ${statsG.mediana} | Desvio-padrão: ${statsG.desvio.toFixed(2)}`;

            document.getElementById("statsB").innerHTML =
                `Min: ${statsB.min} | Max: ${statsB.max} | Média: ${statsB.media.toFixed(2)}
                <br>Mediana: ${statsB.mediana} | Desvio-padrão: ${statsB.desvio.toFixed(2)}`;

            // Função para desenhar histogramas
            function desenharHistograma(id, histData, cor) {
                const canvas = document.getElementById(id);
                const ctxHist = canvas.getContext("2d");

                ctxHist.clearRect(0, 0, canvas.width, canvas.height);

                let maxValor = Math.max(...histData);

                for (let i = 0; i < 256; i++) {
                    let h = (histData[i] / maxValor) * canvas.height;

                    ctxHist.fillStyle = cor;
                    ctxHist.fillRect(i, canvas.height - h, 1, h);
                }
            }

            desenharHistograma("histR", histR, "red");
            desenharHistograma("histG", histG, "green");
            desenharHistograma("histB", histB, "blue");
        }

        /* ----------- 7. ANÁLISE DE BITS E ESTRUTURA ----------- */
        function analisarImagem(img, w, h) {

            // Canvas para obter informações da imagem processada
            const canvas = document.createElement("canvas");
            canvas.width = w;
            canvas.height = h;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);

            const imgData = ctx.getImageData(0, 0, w, h);

            // Informações
            const canais = 4; // R, G, B e Alpha (sempre ao usar getImageData)
            const bitsPorCanal = 8;
            const bitsPorPixel = canais * bitsPorCanal;
            const tamanhoMemoria = imgData.data.length; // bytes do buffer RGBA

            const txt = `
                <strong>Profundidade de cor:</strong> ${bitsPorPixel} bits/pixel (${bitsPorCanal} bits por canal)<br>
                <strong>Número de canais:</strong> ${canais} (R, G, B, A)<br>
                <strong>Dimensões:</strong> ${w} × ${h} pixels<br>
                <strong>Tamanho em memória:</strong> ${tamanhoMemoria} bytes
            `;

            document.getElementById("bitsInfo").innerHTML = txt;
        }

        /* ----------- 8. RELATÓRIO TÉCNICO ----------- */
    document.getElementById("btnRelatorio").addEventListener("click", gerarRelatorio);

    async function gerarRelatorio() {

        const rel = document.getElementById("relatorio");
        rel.style.display = "block";

        const titulo = "<h2>Relatório Técnico — Processamento de Imagem</h2>";

        const operacoes = `
            <h3>1. Operações Implementadas</h3>
            <ul>
                <li>Carregamento e exibição da imagem</li>
                <li>Redução da imagem (75%, 50%, 25%)</li>
                <li>Conversão de formato para WEBP</li>
                <li>Espelhamento vertical</li>
                <li>Geração de imagem em tons de cinza</li>
                <li>Histogramas RGB + estatísticas (mínimo, máximo, média, mediana, desvio-padrão)</li>
                <li>Análise de estrutura da imagem (bits, canais, memória)</li>
            </ul>
        `;

        const resultados = `
            <h3>2. Resultados Gerados</h3>
            <p><strong>Imagem Original:</strong></p>
            <img src="${preview.src}" style="max-width:300px;"><br><br>

            <p><strong>Reduções:</strong></p>
            ${resultContainer.innerHTML}

            <p><strong>Imagem WEBP:</strong></p>
            <img src="${webpPreview.src}" style="max-width:300px;"><br><br>

            <p><strong>Espelhamento Vertical:</strong></p>
            <img src="${flipPreview.src}" style="max-width:300px;"><br><br>

            <p><strong>Tons de Cinza:</strong></p>
            <img src="${grayPreview.src}" style="max-width:300px;"><br><br>

            <h4>Histogramas:</h4>
            <p>Canal R:</p><canvas width="300" height="150">${document.getElementById("histR").toDataURL()}</canvas>
            <p>Canal G:</p><canvas width="300" height="150">${document.getElementById("histG").toDataURL()}</canvas>
            <p>Canal B:</p><canvas width="300" height="150">${document.getElementById("histB").toDataURL()}</canvas>

            <p><strong>Estatísticas:</strong></p>
            <p>R: ${document.getElementById("statsR").innerHTML}</p>
            <p>G: ${document.getElementById("statsG").innerHTML}</p>
            <p>B: ${document.getElementById("statsB").innerHTML}</p>

            <h4>Estrutura da Imagem:</h4>
            <p>${document.getElementById("bitsInfo").innerHTML}</p>
        `;

        const observacoes = `
            <h3>3. Observações e Limitações</h3>
            <ul>
                <li>A análise é baseada na imagem renderizada no navegador e não no arquivo original bruto.</li>
                <li>Todo processamento é feito via JavaScript usando HTML5 Canvas.</li>
                <li>O histograma usa valores de 0 a 255 e pode ser afetado por compressões internas.</li>
                <li>O tamanho em memória reflete a matriz RGBA expandida (4 bytes por pixel).</li>
            </ul>
        `;

        const ferramentas = `
            <h3>4. Ferramentas e Bibliotecas Utilizadas</h3>
            <ul>
                <li>HTML5 + CSS3</li>
                <li>JavaScript puro</li>
                <li>Canvas API (getImageData, putImageData, drawImage)</li>
                <li>FileReader API</li>
            </ul>
        `;

        rel.innerHTML = titulo + operacoes + resultados + observacoes + ferramentas;

        // ativa botão PDF
        document.getElementById("btnBaixarRelatorio").disabled = false;
    }

    /* ----- Baixar PDF usando impressão do navegador ----- */
    document.getElementById("btnBaixarRelatorio").addEventListener("click", () => {
        window.print();
    });
    </script>

</body>
</html>
